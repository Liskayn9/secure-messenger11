<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messenger</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .auth-section { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; }
        .auth-form input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        .btn-primary { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        .btn-primary:hover { background: #0056b3; }
        
        .main-section { display: none; }
        .header { background: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { display: flex; height: calc(100vh - 60px); }
        
        .sidebar { width: 300px; background: white; padding: 1rem; border-right: 1px solid #ddd; }
        .search-container input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .friends-list { margin-top: 1rem; }
        .friend-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .friend-item:hover { background: #f5f5f5; }
        .friend-item.online { border-left: 3px solid green; }
        .friend-item.offline { border-left: 3px solid #ccc; }
        
        .chat-section { flex: 1; display: flex; flex-direction: column; }
        .messages-container { flex: 1; padding: 1rem; overflow-y: auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 70%; }
        .message.outgoing { background: #007bff; color: white; margin-left: auto; }
        .message.incoming { background: #f1f1f1; color: black; }
        .message-input-container { display: flex; padding: 1rem; border-top: 1px solid #ddd; background: white; }
        .message-input-container input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px; }
        
        .search-results { position: absolute; background: white; border: 1px solid #ddd; width: 280px; max-height: 200px; overflow-y: auto; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .action-btn { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="authSection" class="auth-section">
        <div class="auth-container">
            <h1 style="text-align: center; margin-bottom: 1rem;">Secure Messenger</h1>
            
            <div id="loginForm" class="auth-form">
                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button id="loginBtn" class="btn-primary">–í–æ–π—Ç–∏</button>
                <p style="text-align: center; margin-top: 1rem;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegister" style="color: #007bff;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            </div>
            
            <div id="registerForm" class="auth-form" style="display: none;">
                <input type="text" id="registerUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="email" id="registerEmail" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button id="registerBtn" class="btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <p style="text-align: center; margin-top: 1rem;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="showLogin" style="color: #007bff;">–í–æ–π—Ç–∏</a></p>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="mainSection" class="main-section">
        <header class="header">
            <h2>Secure Messenger</h2>
            <div>
                <button id="themeToggle" class="btn-primary" style="width: auto; margin-right: 10px;">–¢–µ–º–∞</button>
                <button id="logoutBtn" class="btn-primary" style="width: auto;">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="container">
            <!-- –°–∞–π–¥–±–∞—Ä -->
            <div class="sidebar">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <div class="friends-section">
                    <h3>–î—Ä—É–∑—å—è</h3>
                    <div id="friendsList" class="friends-list"></div>
                </div>
            </div>

            <!-- –ß–∞—Ç -->
            <div id="chatSection" class="chat-section">
                <div class="chat-header" style="padding: 1rem; background: white; border-bottom: 1px solid #ddd;">
                    <h3 id="currentChatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                </div>
                
                <div id="messagesContainer" class="messages-container"></div>
                
                <div class="message-input-container">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button id="sendMessageBtn" class="btn-primary" style="width: auto;" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class SecureMessenger {
            constructor() {
                this.API_BASE = window.location.origin + '/api';
                this.user = null;
                this.token = localStorage.getItem('token');
                this.currentChat = null;
                this.socket = null;
                
                console.log('üåê API Base:', this.API_BASE);
                this.init();
            }

            async init() {
                this.setupEventListeners();
                if (this.token) {
                    await this.loadUserData();
                } else {
                    this.showAuth();
                }
            }

            setupEventListeners() {
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('registerBtn').addEventListener('click', () => this.register());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('showRegister').addEventListener('click', () => this.showRegisterForm());
                document.getElementById('showLogin').addEventListener('click', () => this.showLoginForm());
                document.getElementById('searchInput').addEventListener('input', (e) => this.searchUsers(e.target.value));
                document.getElementById('sendMessageBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async login() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }

                try {
                    const response = await fetch(this.API_BASE + '/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('token', this.token);
                        this.showMain();
                        this.loadFriends();
                        this.connectSocket();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                }
            }

            async register() {
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                const email = document.getElementById('registerEmail').value;

                if (!username || !password) {
                    alert('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
                    return;
                }

                try {
                    const response = await fetch(this.API_BASE + '/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, email })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('token', this.token);
                        this.showMain();
                        this.loadFriends();
                        this.connectSocket();
                        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                }
            }

            async loadUserData() {
                try {
                    await this.loadFriends();
                    this.showMain();
                    this.connectSocket();
                } catch (error) {
                    localStorage.removeItem('token');
                    this.showAuth();
                }
            }

            async loadFriends() {
                try {
                    const response = await fetch(this.API_BASE + '/friends', {
                        headers: { 'Authorization': 'Bearer ' + this.token }
                    });
                    const data = await response.json();
                    if (data.success) this.displayFriends(data.friends);
                } catch (error) {
                    console.error('Error loading friends:', error);
                }
            }

            displayFriends(friends) {
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = '';

                friends.forEach(friend => {
                    const friendElement = document.createElement('div');
                    friendElement.className = `friend-item ${friend.isOnline ? 'online' : 'offline'}`;
                    friendElement.innerHTML = `
                        <div><strong>${friend.username}</strong></div>
                        <small>${friend.isOnline ? 'online' : 'offline'}</small>
                    `;
                    friendElement.addEventListener('click', () => this.openChat(friend));
                    friendsList.appendChild(friendElement);
                });
            }

            async searchUsers(query) {
                if (query.length < 2) {
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch(this.API_BASE + '/users/search?query=' + query, {
                        headers: { 'Authorization': 'Bearer ' + this.token }
                    });
                    const data = await response.json();
                    if (data.success) this.displaySearchResults(data.users);
                } catch (error) {
                    console.error('Error searching:', error);
                }
            }

            displaySearchResults(users) {
                const results = document.getElementById('searchResults');
                results.innerHTML = '';

                users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'search-result-item';
                    userElement.innerHTML = `
                        <div>${user.username}</div>
                        <button class="action-btn" onclick="messenger.addFriend('${user.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    `;
                    results.appendChild(userElement);
                });
            }

            async addFriend(friendId) {
                try {
                    const response = await fetch(this.API_BASE + '/friends/request', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + this.token
                        },
                        body: JSON.stringify({ friendId })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                        document.getElementById('searchResults').innerHTML = '';
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
                }
            }

            async openChat(friend) {
                this.currentChat = friend;
                document.getElementById('currentChatName').textContent = friend.username;
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                await this.loadMessages(friend.id);
            }

            async loadMessages(friendId) {
                try {
                    const response = await fetch(this.API_BASE + '/messages/' + friendId, {
                        headers: { 'Authorization': 'Bearer ' + this.token }
                    });
                    const data = await response.json();
                    if (data.success) this.displayMessages(data.messages);
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            displayMessages(messages) {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${message.from === this.user.username ? 'outgoing' : 'incoming'}`;
                    messageElement.innerHTML = `
                        <div>${message.message}</div>
                        <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                    `;
                    container.appendChild(messageElement);
                });
                container.scrollTop = container.scrollHeight;
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();

                if (!message || !this.currentChat) return;

                if (this.socket) {
                    this.socket.emit('send_message', {
                        to: this.currentChat.id,
                        message: message
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                    const container = document.getElementById('messagesContainer');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message outgoing';
                    messageElement.innerHTML = `
                        <div>${message}</div>
                        <small>${new Date().toLocaleTimeString()}</small>
                    `;
                    container.appendChild(messageElement);
                    container.scrollTop = container.scrollHeight;
                }

                input.value = '';
            }

            connectSocket() {
                if (!this.token) return;

                this.socket = io({
                    auth: { token: this.token }
                });

                this.socket.on('new_message', (messageData) => {
                    if (this.currentChat && messageData.from === this.currentChat.username) {
                        const container = document.getElementById('messagesContainer');
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message incoming';
                        messageElement.innerHTML = `
                            <div>${messageData.message}</div>
                            <small>${new Date(messageData.timestamp).toLocaleTimeString()}</small>
                        `;
                        container.appendChild(messageElement);
                        container.scrollTop = container.scrollHeight;
                    }
                });
            }

            logout() {
                localStorage.removeItem('token');
                this.token = null;
                this.user = null;
                if (this.socket) this.socket.disconnect();
                this.showAuth();
            }

            showAuth() {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('mainSection').style.display = 'none';
            }

            showMain() {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
            }

            showRegisterForm() {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }

            showLoginForm() {
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            window.messenger = new SecureMessenger();
        });
    </script>
</body>
</html>